<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimax Invoice XML Converter - Production Ready</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #718096;
            font-size: 1.1rem;
        }
        
        .step {
            margin-bottom: 32px;
            padding: 24px;
            background: #f7fafc;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .step h2 {
            color: #667eea;
            margin-bottom: 16px;
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 48px 24px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .file-upload:hover {
            border-color: #5a67d8;
            background: #f7fafc;
            transform: translateY(-2px);
        }
        
        .file-upload.dragover {
            border-color: #5a67d8;
            background: #ebf4ff;
        }
        
        .file-upload-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            color: #667eea;
        }
        
        .file-upload-text {
            font-size: 1.2rem;
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 8px;
        }
        
        .file-upload-hint {
            color: #718096;
            font-size: 0.9rem;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 8px;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #718096, #4a5568);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .setting-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .setting-item label {
            font-weight: 600;
            color: #2d3748;
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        select, input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: white;
        }
        
        select:focus, input[type="text"]:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .preview {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
        }
        
        .preview pre {
            background: white;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
            border: 1px solid #e2e8f0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }
        
        .alert-error {
            background: #fed7d7;
            color: #c53030;
            border: 1px solid #feb2b2;
        }
        
        .alert-success {
            background: #c6f6d5;
            color: #2f855a;
            border: 1px solid #9ae6b4;
        }
        
        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }
        
        .hidden {
            display: none;
        }
        
        .data-preview {
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .data-preview h3 {
            background: #667eea;
            color: white;
            padding: 12px 16px;
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .table-container {
            max-height: 300px;
            overflow: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        th, td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            text-align: left;
        }
        
        th {
            background: #f7fafc;
            color: #2d3748;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        tbody tr:nth-child(even) {
            background: #f7fafc;
        }
        
        .actions {
            text-align: center;
            margin-top: 32px;
            padding: 24px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            display: block;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            margin-top: 4px;
        }
        
        .info-box {
            background: linear-gradient(135deg, #ebf4ff, #e6fffa);
            border: 1px solid #90cdf4;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .info-box h3 {
            color: #2c5282;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }
        
        .info-box p {
            color: #2d3748;
            line-height: 1.6;
        }
        
        .processing {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        
        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 16px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ Minimax XML Converter</h1>
            <p>Convert your invoice export to Minimax-compatible XML format</p>
        </div>
        
        <div class="info-box">
            <h3>‚úÖ Smart Account Selection</h3>
            <p>This converter automatically selects the correct Slovenian accounting codes based on customer country and business type. It uses the "Date due" column from your Excel file and intelligently maps accounts for domestic (Slovenia), EU, and third-country transactions according to Slovenian accounting standards. The converter also properly handles credit notes with negative VAT values.</p>
        </div>
        
        <!-- Step 1: Upload File -->
        <div class="step">
            <h2>üìÅ Step 1: Upload Your Invoice Export</h2>
            <div class="file-upload" id="fileUpload">
                <div class="file-upload-icon">üìä</div>
                <div class="file-upload-text">Click or drag and drop your file here</div>
                <div class="file-upload-hint">Supports Excel (.xlsx, .xls) and CSV files up to 30MB</div>
                <input type="file" id="dataFile" accept=".xlsx,.xls,.csv" />
            </div>
            <div id="dataPreview" class="data-preview hidden"></div>
            <div id="dataStats" class="stats hidden"></div>
        </div>
        
        <!-- Step 2: Settings -->
        <div class="step hidden" id="settingsStep">
            <h2>‚öôÔ∏è Step 2: Configure XML Settings</h2>
            <div class="settings-grid">
                <div class="setting-item">
                    <label for="defaultInvoiceType">Document Type</label>
                    <select id="defaultInvoiceType">
                        <option value="IR">IR - Issued Invoice (Izdani Raƒçun)</option>
                        <option value="PR">PR - Received Invoice (Prejeti Raƒçun)</option>
                        <option value="FT">FT - Financial Document</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="businessType">Business Type</label>
                    <select id="businessType">
                        <option value="products">Products (Izdelki)</option>
                        <option value="services">Services (Storitve)</option>
                        <option value="goods">Goods (Blago)</option>
                        <option value="materials">Materials (Material)</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="includeCustomers">Include Customer Data</label>
                    <select id="includeCustomers">
                        <option value="true">Yes - Include customer section</option>
                        <option value="false">No - Only transactions</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="customerCodePrefix">Customer Code Prefix</label>
                    <input type="text" id="customerCodePrefix" value="CUST" placeholder="e.g., CUST">
                </div>
                
                <div class="setting-item">
                    <label for="homeCountry">Home Country</label>
                    <select id="homeCountry">
                        <option value="Slovenia">Slovenia</option>
                        <option value="Croatia">Croatia</option>
                        <option value="Austria">Austria</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="countryColumn">Country Column</label>
                    <select id="countryColumn">
                        <option value="auto">Auto-detect</option>
                        <option value="Country">Country</option>
                        <option value="Shipping Country">Shipping Country</option>
                        <option value="Billing Country">Billing Country</option>
                    </select>
                </div>
            </div>
            
            <div class="info-box" style="margin-top: 20px;">
                <h3>üìä Account Mapping Preview</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #48bb78;">
                        <strong>üá∏üáÆ Slovenia (Domestic)</strong><br>
                        <small id="domesticPreview">Receivables: 1200 | Revenue: 7600 | VAT: 26070</small>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #4299e1;">
                        <strong>üá™üá∫ EU Countries</strong><br>
                        <small id="euPreview">Receivables: 1211 | Revenue: 76101 | VAT: 26071 (OSS)</small>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #ed8936;">
                        <strong>üåç Third Countries</strong><br>
                        <small id="thirdPreview">Receivables: 1210 | Revenue: 76102 | VAT: No VAT</small>
                    </div>
                </div>
                <p style="margin-top: 15px; font-size: 0.9rem; color: #718096;">Revenue accounts automatically selected based on business type and customer country. You can override these below.</p>
            </div>
            
            <div style="margin-top: 20px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">üîß Manual Account Overrides (Optional)</h3>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>üá∏üáÆ Domestic Receivables</label>
                        <input type="text" id="domesticReceivables" placeholder="Auto: 1200">
                    </div>
                    <div class="setting-item">
                        <label>üá∏üáÆ Domestic Revenue</label>
                        <input type="text" id="domesticRevenue" placeholder="Auto: Based on business type">
                    </div>
                    <div class="setting-item">
                        <label>üá∏üáÆ Domestic VAT</label>
                        <input type="text" id="domesticVAT" placeholder="Auto: 26070">
                    </div>
                    
                    <div class="setting-item">
                        <label>üá™üá∫ EU Receivables</label>
                        <input type="text" id="euReceivables" placeholder="Auto: 1211">
                    </div>
                    <div class="setting-item">
                        <label>üá™üá∫ EU Revenue</label>
                        <input type="text" id="euRevenue" placeholder="Auto: Based on business type">
                    </div>
                    <div class="setting-item">
                        <label>üá™üá∫ EU VAT</label>
                        <input type="text" id="euVAT" placeholder="Auto: 26071 (OSS)">
                    </div>
                    
                    <div class="setting-item">
                        <label>üåç Third Country Receivables</label>
                        <input type="text" id="thirdReceivables" placeholder="Auto: 1210">
                    </div>
                    <div class="setting-item">
                        <label>üåç Third Country Revenue</label>
                        <input type="text" id="thirdRevenue" placeholder="Auto: Based on business type">
                    </div>
                    <div class="setting-item">
                        <label>üåç Third Country VAT</label>
                        <input type="text" id="thirdVAT" placeholder="Auto: No VAT (leave empty)">
                    </div>
                </div>
                <p style="margin-top: 15px; font-size: 0.9rem; color: #718096;">Leave fields empty to use automatic selection. Fill in to override specific accounts.</p>
            </div>
        </div>
        
        <!-- Step 3: Generate XML -->
        <div class="step hidden" id="xmlStep">
            <h2>üöÄ Step 3: Generate and Download XML</h2>
            <div class="actions">
                <button class="btn" id="generateBtn" onclick="generateXML()">
                    <span>üìÑ</span> Generate Minimax XML
                </button>
                <button class="btn btn-success hidden" id="downloadBtn" onclick="downloadXML()">
                    <span>‚¨áÔ∏è</span> Download XML File
                </button>
                <button class="btn btn-secondary hidden" id="copyBtn" onclick="copyToClipboard()">
                    <span>üìã</span> Copy to Clipboard
                </button>
                <button class="btn btn-secondary hidden" id="previewToggle" onclick="togglePreview()">
                    <span>üëÅÔ∏è</span> Preview XML
                </button>
            </div>
            <div id="downloadInfo" class="hidden" style="margin-top: 15px; padding: 15px; background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 8px; font-size: 0.9rem;">
                <strong>üí° Multiple Options:</strong>
                <ul style="margin: 10px 0 0 20px; line-height: 1.6;">
                    <li><strong>Download:</strong> Direct file download (works in most browsers)</li>
                    <li><strong>Copy:</strong> Copy to clipboard, then paste in text editor and save as .xml</li>
                    <li><strong>Preview:</strong> View XML content for manual copying</li>
                </ul>
            </div>
            <div id="xmlPreview" class="preview hidden"></div>
        </div>
        
        <div id="messages"></div>
    </div>

    <script>
        let invoiceData = [];
        let generatedXML = '';
        
        // File upload handling
        document.getElementById('dataFile').addEventListener('change', handleFileSelect);
        
        const fileUpload = document.getElementById('fileUpload');
        fileUpload.addEventListener('click', () => document.getElementById('dataFile').click());
        fileUpload.addEventListener('dragover', handleDragOver);
        fileUpload.addEventListener('drop', handleFileDrop);
        fileUpload.addEventListener('dragenter', e => e.preventDefault());
        fileUpload.addEventListener('dragleave', e => fileUpload.classList.remove('dragover'));
        
        function handleDragOver(e) {
            e.preventDefault();
            fileUpload.classList.add('dragover');
        }
        
        function handleFileDrop(e) {
            e.preventDefault();
            fileUpload.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }
        
        function processFile(file) {
            if (file.size > 30 * 1024 * 1024) {
                showMessage('File size exceeds 30MB limit. Please use a smaller file.', 'error');
                return;
            }
            
            showProcessing('Reading file...');
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileExtension === 'csv') {
                processCSV(file);
            } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                processExcel(file);
            } else {
                hideProcessing();
                showMessage('Please upload a CSV or Excel file (.csv, .xlsx, .xls)', 'error');
            }
        }
        
        function processCSV(file) {
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    hideProcessing();
                    if (results.errors.length > 0) {
                        showMessage('Error parsing CSV: ' + results.errors[0].message, 'error');
                        return;
                    }
                    
                    invoiceData = results.data;
                    displayDataPreview();
                    showSettings();
                    showMessage(`‚úÖ CSV file loaded successfully! Found ${invoiceData.length} records.`, 'success');
                },
                error: function(error) {
                    hideProcessing();
                    showMessage('Error reading CSV file: ' + error.message, 'error');
                }
            });
        }
        
        function processExcel(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON with proper date handling
                    invoiceData = XLSX.utils.sheet_to_json(worksheet, {
                        raw: false,
                        dateNF: 'yyyy-mm-dd'
                    });
                    
                    // Clean up and process data
                    invoiceData = invoiceData.map(row => {
                        const cleanRow = {};
                        Object.keys(row).forEach(key => {
                            if (key && key.trim() !== '') {
                                cleanRow[key] = row[key];
                            }
                        });
                        return cleanRow;
                    }).filter(row => Object.keys(row).length > 0);
                    
                    hideProcessing();
                    displayDataPreview();
                    showSettings();
                    showMessage(`‚úÖ Excel file loaded successfully! Found ${invoiceData.length} records.`, 'success');
                    
                } catch (error) {
                    hideProcessing();
                    showMessage('Error reading Excel file: ' + error.message, 'error');
                }
            };
            reader.onerror = function() {
                hideProcessing();
                showMessage('Error reading file. Please try again.', 'error');
            };
            reader.readAsArrayBuffer(file);
        }
        
        function displayDataPreview() {
            if (invoiceData.length === 0) return;
            
            const preview = document.getElementById('dataPreview');
            const stats = document.getElementById('dataStats');
            
            // Calculate statistics
            const totalInvoices = invoiceData.length;
            const totalAmount = invoiceData.reduce((sum, row) => {
                const amount = parseFloat(row['Total w/ tax'] || row['Total'] || 0);
                return sum + (isNaN(amount) ? 0 : amount);
            }, 0);
            
            const uniqueCustomers = new Set();
            invoiceData.forEach(row => {
                if (row['Name']) uniqueCustomers.add(row['Name']);
            });
            
            const paidInvoices = invoiceData.filter(row => 
                row['Paid'] && row['Paid'].toString().toLowerCase() === 'yes'
            ).length;
            
            // Display statistics
            stats.innerHTML = `
                <div class="stat-item">
                    <span class="stat-value">${totalInvoices}</span>
                    <div class="stat-label">Total Invoices</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${uniqueCustomers.size}</span>
                    <div class="stat-label">Unique Customers</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${paidInvoices}</span>
                    <div class="stat-label">Paid Invoices</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${totalAmount.toFixed(2)}</span>
                    <div class="stat-label">Total Amount</div>
                </div>
            `;
            
            // Display data preview
            const headers = Object.keys(invoiceData[0]);
            const maxRows = 5;
            
            let html = '<h3>üìä Data Preview (first ' + maxRows + ' rows)</h3>';
            html += '<div class="table-container"><table>';
            html += '<thead><tr>' + headers.map(h => '<th>' + escapeHtml(h) + '</th>').join('') + '</tr></thead>';
            html += '<tbody>';
            
            for (let i = 0; i < Math.min(maxRows, invoiceData.length); i++) {
                html += '<tr>';
                headers.forEach(header => {
                    const value = invoiceData[i][header];
                    html += '<td>' + escapeHtml(String(value || '')) + '</td>';
                });
                html += '</tr>';
            }
            html += '</tbody></table></div>';
            
            preview.innerHTML = html;
            preview.classList.remove('hidden');
            stats.classList.remove('hidden');
        }
        
        function showSettings() {
            document.getElementById('settingsStep').classList.remove('hidden');
            document.getElementById('xmlStep').classList.remove('hidden');
            
            // Add event listeners for preview updates
            document.getElementById('businessType').addEventListener('change', updateAccountPreview);
            
            // Add event listeners for manual override fields
            const overrideFields = [
                'domesticReceivables', 'domesticRevenue', 'domesticVAT',
                'euReceivables', 'euRevenue', 'euVAT',
                'thirdReceivables', 'thirdRevenue', 'thirdVAT'
            ];
            
            overrideFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateAccountPreview);
                }
            });
            
            // Initial preview update
            updateAccountPreview();
        }
        
        function generateXML() {
            try {
                if (invoiceData.length === 0) {
                    showMessage('No data to process. Please upload a file first.', 'error');
                    return;
                }
                
                showProcessing('Generating XML...');
                
                // Small delay to show processing
                setTimeout(() => {
                    try {
                        generatedXML = createMinimaxXML(invoiceData);
                        
                        if (!generatedXML || generatedXML.trim() === '') {
                            throw new Error('Generated XML is empty');
                        }
                        
                        hideProcessing();
                        
                        // Show all action buttons
                        document.getElementById('downloadBtn').classList.remove('hidden');
                        document.getElementById('copyBtn').classList.remove('hidden');
                        document.getElementById('previewToggle').classList.remove('hidden');
                        document.getElementById('downloadInfo').classList.remove('hidden');
                        
                        showMessage(`üéâ XML generated successfully! Created ${invoiceData.length} invoice records (${(generatedXML.length / 1024).toFixed(1)} KB)`, 'success');
                        
                    } catch (error) {
                        hideProcessing();
                        showMessage('Error generating XML: ' + error.message, 'error');
                        console.error('XML Generation Error:', error);
                    }
                }, 100);
                
            } catch (error) {
                hideProcessing();
                showMessage('Error generating XML: ' + error.message, 'error');
                console.error('XML Generation Error:', error);
            }
        }
        
        function createMinimaxXML(data) {
            const settings = {
                invoiceType: document.getElementById('defaultInvoiceType').value,
                businessType: document.getElementById('businessType').value,
                includeCustomers: document.getElementById('includeCustomers').value === 'true',
                customerCodePrefix: document.getElementById('customerCodePrefix').value || 'CUST',
                homeCountry: document.getElementById('homeCountry').value,
                countryColumn: document.getElementById('countryColumn').value
            };
            
            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xml += '<miniMAXUvozKnjigovodstvo xmlns="https://moj.minimax.si/SI/CommonWeb/documents/schemas/miniMAXUvozKnjigovodstvo" ';
            xml += 'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" ';
            xml += 'xsi:schemaLocation="https://moj.minimax.si/SI/CommonWeb/documents/schemas/miniMAXUvozKnjigovodstvo ';
            xml += 'https://moj.minimax.si/SI/CommonWeb/documents/schemas/miniMAXUvozKnjigovodstvo.xsd">\n';
            
            // Extract unique customers if enabled
            if (settings.includeCustomers) {
                const customers = new Map();
                data.forEach((row, index) => {
                    const customerName = row['Name'];
                    if (customerName && !customers.has(customerName)) {
                        const customerCode = settings.customerCodePrefix + (index + 1).toString().padStart(3, '0');
                        const country = getCustomerCountry(row, settings.countryColumn);
                        customers.set(customerName, {
                            code: customerCode,
                            name: customerName,
                            address: row['Address'] || '',
                            postalCode: row['Postal code'] || '',
                            city: row['City'] || '',
                            country: country,
                            taxNumber: row['Tax number'] || ''
                        });
                    }
                });
                
                // Add customers section following exact schema order
                if (customers.size > 0) {
                    xml += '  <Stranke>\n';
                    customers.forEach(customer => {
                        xml += '    <Stranka>\n';
                        xml += `      <Sifra>${escapeXml(customer.code)}</Sifra>\n`;
                        xml += `      <Naziv>${escapeXml(customer.name)}</Naziv>\n`;
                        // Following exact schema sequence order
                        if (customer.address) {
                            xml += `      <Naslov>${escapeXml(customer.address)}</Naslov>\n`;
                        }
                        if (customer.country) {
                            xml += `      <KraticaDrzave>${escapeXml(customer.country)}</KraticaDrzave>\n`;
                        }
                        if (customer.postalCode) {
                            xml += `      <PostnaStevilka>${escapeXml(customer.postalCode)}</PostnaStevilka>\n`;
                        }
                        if (customer.city) {
                            xml += `      <NazivPoste>${escapeXml(customer.city)}</NazivPoste>\n`;
                        }
                        // Add DavcniZavezanec before IdentifikacijskaStevilka as per schema
                        if (customer.taxNumber) {
                            xml += `      <DavcniZavezanec>D</DavcniZavezanec>\n`;
                            xml += `      <IdentifikacijskaStevilka>${escapeXml(customer.taxNumber)}</IdentifikacijskaStevilka>\n`;
                        }
                        xml += '    </Stranka>\n';
                    });
                    xml += '  </Stranke>\n';
                }
            }
            
            // Add invoices section following exact schema structure
            xml += '  <Temeljnice>\n';
            data.forEach((row, index) => {
                const netAmount = parseFloat(row['Total'] || 0);
                const grossAmount = parseFloat(row['Total w/ tax'] || netAmount);
                const taxAmount = grossAmount - netAmount;
                const customerCode = settings.includeCustomers ? 
                    settings.customerCodePrefix + (index + 1).toString().padStart(3, '0') : '';
                
                // Check if this is a credit note
                const isCreditNote = row['Type'] && row['Type'].toString().toLowerCase().includes('credit');
                const documentPrefix = isCreditNote ? 'Credit note' : 'Invoice';
                
                // Get customer country and determine accounts
                const customerCountry = getCustomerCountry(row, settings.countryColumn);
                const countryType = classifyCountry(customerCountry, settings.homeCountry);
                const accounts = getAccountsByCountryType(countryType, settings.businessType);
                
                // Debug for first record
                if (index === 0) {
                    console.log('Account selection for first record:');
                    console.log('Customer country:', customerCountry);
                    console.log('Country type:', countryType);
                    console.log('Document type:', isCreditNote ? 'Credit Note' : 'Invoice');
                    console.log('Selected accounts:');
                    console.log('  Receivables:', accounts.receivables);
                    console.log('  Revenue:', accounts.revenue);
                    console.log('  VAT:', accounts.vat || 'No VAT');
                }
                
                xml += '    <Temeljnica>\n';
                
                // GlavaTemeljnice section (required structure)
                xml += '      <GlavaTemeljnice>\n';
                xml += `        <SifraVrsteTemeljnice>${escapeXml(settings.invoiceType)}</SifraVrsteTemeljnice>\n`;
                xml += `        <DatumTemeljnice>${formatDate(row['Date'])}</DatumTemeljnice>\n`;
                xml += `        <OpisGlaveTemeljnice>${escapeXml(row['Number'] || documentPrefix + ' ' + (index + 1))}</OpisGlaveTemeljnice>\n`;
                xml += '      </GlavaTemeljnice>\n';
                
                // VrsticeTemeljnice section (correct structure from schema)
                xml += '      <VrsticeTemeljnice>\n';
                
                const invoiceDate = formatDate(row['Date']);
                const dueDate = formatDate(row['Date due']); // Use the Date due column from Excel
                
                // Debug dates for first record
                if (index === 0) {
                    console.log('First record dates:');
                    console.log('Raw invoice date from Excel:', row['Date'], '(Type:', typeof row['Date'], ')');
                    console.log('Raw due date from Excel:', row['Date due'], '(Type:', typeof row['Date due'], ')');
                    console.log('Formatted invoice date:', invoiceDate);
                    console.log('Formatted due date:', dueDate);
                }
                
                // Receivables entry (debit) - following exact schema sequence
                xml += '        <VrsticaTemeljnice>\n';
                xml += `          <OpisVrsticeTemeljnice>${documentPrefix} ${escapeXml(row['Number'] || '')} - ${escapeXml(row['Name'] || '')}</OpisVrsticeTemeljnice>\n`;
                xml += `          <SifraKonta>${escapeXml(accounts.receivables)}</SifraKonta>\n`;
                if (customerCode) {
                    xml += `          <SifraStranke>${escapeXml(customerCode)}</SifraStranke>\n`;
                }
                // Add required dates for account 1200/1210/1211
                xml += `          <DatumZapadlosti>${dueDate}</DatumZapadlosti>\n`;
                xml += `          <DatumOpravljanja>${invoiceDate}</DatumOpravljanja>\n`;
                if (row['Reference']) {
                    xml += `          <VezaZaPlacilo>${escapeXml(row['Reference'])}</VezaZaPlacilo>\n`;
                }
                xml += `          <ZnesekVBremeVDomaciDenarniEnoti>${grossAmount.toFixed(2)}</ZnesekVBremeVDomaciDenarniEnoti>\n`;
                xml += '        </VrsticaTemeljnice>\n';
                
                // Revenue entry (credit) - following exact schema sequence
                xml += '        <VrsticaTemeljnice>\n';
                xml += `          <OpisVrsticeTemeljnice>Revenue - ${escapeXml(row['Number'] || '')}</OpisVrsticeTemeljnice>\n`;
                xml += `          <SifraKonta>${escapeXml(accounts.revenue)}</SifraKonta>\n`;
                xml += `          <DatumOpravljanja>${invoiceDate}</DatumOpravljanja>\n`;
                xml += `          <ZnesekVDobroVDomaciDenarniEnoti>${netAmount.toFixed(2)}</ZnesekVDobroVDomaciDenarniEnoti>\n`;
                xml += '        </VrsticaTemeljnice>\n';
                
                // VAT entry if applicable (credit) - following exact schema sequence
                // For credit notes, taxAmount will be negative if there's VAT
                // The condition checks if there's any VAT (positive or negative) and if VAT account exists
                if (Math.abs(taxAmount) > 0.001 && accounts.vat) {
                    xml += '        <VrsticaTemeljnice>\n';
                    xml += `          <OpisVrsticeTemeljnice>VAT - ${escapeXml(row['Number'] || '')}</OpisVrsticeTemeljnice>\n`;
                    xml += `          <SifraKonta>${escapeXml(accounts.vat)}</SifraKonta>\n`;
                    xml += `          <DatumOpravljanja>${invoiceDate}</DatumOpravljanja>\n`;
                    xml += `          <ZnesekVDobroVDomaciDenarniEnoti>${taxAmount.toFixed(2)}</ZnesekVDobroVDomaciDenarniEnoti>\n`;
                    xml += '        </VrsticaTemeljnice>\n';
                }
                
                xml += '      </VrsticeTemeljnice>\n';
                xml += '    </Temeljnica>\n';
            });
            
            xml += '  </Temeljnice>\n';
            xml += '</miniMAXUvozKnjigovodstvo>';
            
            return xml;
        }
        
        // EU countries list
        const EU_COUNTRIES = [
            'Austria', 'Belgium', 'Bulgaria', 'Croatia', 'Cyprus', 'Czech Republic', 
            'Denmark', 'Estonia', 'Finland', 'France', 'Germany', 'Greece', 
            'Hungary', 'Ireland', 'Italy', 'Latvia', 'Lithuania', 'Luxembourg', 
            'Malta', 'Netherlands', 'Poland', 'Portugal', 'Romania', 'Slovakia', 
            'Slovenia', 'Spain', 'Sweden'
        ];
        
        function getCustomerCountry(row, countryColumnSetting) {
            // Auto-detect country column
            if (countryColumnSetting === 'auto') {
                // Prefer shipping country, then billing country, then generic country
                return row['Shipping Country'] || row['Billing Country'] || row['Country'] || '';
            }
            return row[countryColumnSetting] || '';
        }
        
        function classifyCountry(country, homeCountry) {
            if (!country) return 'domestic';
            
            // Normalize country names for comparison
            const normalizedCountry = country.trim();
            const normalizedHome = homeCountry.trim();
            
            // Check if it's the home country
            if (normalizedCountry.toLowerCase() === normalizedHome.toLowerCase()) {
                return 'domestic';
            }
            
            // Check if it's an EU country
            if (EU_COUNTRIES.some(euCountry => 
                euCountry.toLowerCase() === normalizedCountry.toLowerCase())) {
                return 'eu';
            }
            
            // Everything else is third country
            return 'third';
        }
        
        function getAccountsByCountryType(countryType, businessType) {
            const accounts = {
                receivables: '1200',  // Default
                revenue: '7600',      // Default
                vat: '26070'          // Default
            };
            
            // Check for manual overrides first
            const overrides = getManualOverrides();
            
            if (countryType === 'domestic') {
                // Slovenia - domestic accounts
                accounts.receivables = overrides.domesticReceivables || '1200';
                accounts.vat = overrides.domesticVAT || '26070';
                
                if (overrides.domesticRevenue) {
                    accounts.revenue = overrides.domesticRevenue;
                } else {
                    switch (businessType) {
                        case 'products':
                            accounts.revenue = '7600';
                            break;
                        case 'services':
                            accounts.revenue = '7601';
                            break;
                        case 'goods':
                            accounts.revenue = '7620';
                            break;
                        case 'materials':
                            accounts.revenue = '7621';
                            break;
                        default:
                            accounts.revenue = '7600';
                    }
                }
            } else if (countryType === 'eu') {
                // EU countries
                accounts.receivables = overrides.euReceivables || '1211';
                accounts.vat = overrides.euVAT || '26071'; // OSS system
                
                if (overrides.euRevenue) {
                    accounts.revenue = overrides.euRevenue;
                } else {
                    switch (businessType) {
                        case 'products':
                            accounts.revenue = '76101';
                            break;
                        case 'services':
                            accounts.revenue = '76111';
                            break;
                        case 'goods':
                            accounts.revenue = '76301';
                            break;
                        case 'materials':
                            accounts.revenue = '76311';
                            break;
                        default:
                            accounts.revenue = '76101';
                    }
                }
            } else {
                // Third countries
                accounts.receivables = overrides.thirdReceivables || '1210';
                accounts.vat = overrides.thirdVAT || ''; // No VAT by default for third countries
                
                if (overrides.thirdRevenue) {
                    accounts.revenue = overrides.thirdRevenue;
                } else {
                    switch (businessType) {
                        case 'products':
                            accounts.revenue = '76102';
                            break;
                        case 'services':
                            accounts.revenue = '76112';
                            break;
                        case 'goods':
                            accounts.revenue = '76302';
                            break;
                        case 'materials':
                            accounts.revenue = '76312';
                            break;
                        default:
                            accounts.revenue = '76102';
                    }
                }
            }
            
            return accounts;
        }
        
        function getManualOverrides() {
            return {
                domesticReceivables: document.getElementById('domesticReceivables').value.trim(),
                domesticRevenue: document.getElementById('domesticRevenue').value.trim(),
                domesticVAT: document.getElementById('domesticVAT').value.trim(),
                euReceivables: document.getElementById('euReceivables').value.trim(),
                euRevenue: document.getElementById('euRevenue').value.trim(),
                euVAT: document.getElementById('euVAT').value.trim(),
                thirdReceivables: document.getElementById('thirdReceivables').value.trim(),
                thirdRevenue: document.getElementById('thirdRevenue').value.trim(),
                thirdVAT: document.getElementById('thirdVAT').value.trim()
            };
        }
        
        function updateAccountPreview() {
            const businessType = document.getElementById('businessType').value;
            
            // Get accounts for each market type
            const domesticAccounts = getAccountsByCountryType('domestic', businessType);
            const euAccounts = getAccountsByCountryType('eu', businessType);
            const thirdAccounts = getAccountsByCountryType('third', businessType);
            
            // Update preview displays
            document.getElementById('domesticPreview').textContent = 
                `Receivables: ${domesticAccounts.receivables} | Revenue: ${domesticAccounts.revenue} | VAT: ${domesticAccounts.vat}`;
            
            document.getElementById('euPreview').textContent = 
                `Receivables: ${euAccounts.receivables} | Revenue: ${euAccounts.revenue} | VAT: ${euAccounts.vat} (OSS)`;
            
            document.getElementById('thirdPreview').textContent = 
                `Receivables: ${thirdAccounts.receivables} | Revenue: ${thirdAccounts.revenue} | VAT: ${thirdAccounts.vat || 'No VAT'}`;
        }
        
        function formatDate(dateValue) {
            if (!dateValue) return new Date().toISOString().split('T')[0];
            
            // Handle Excel date serial numbers
            if (typeof dateValue === 'number') {
                // Excel epoch is December 30, 1899
                const excelEpoch = new Date(1899, 11, 30);
                const date = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                
                // Get the date components to avoid timezone issues
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            }
            
            // Handle string dates (like "4/1/25", "2025-04-01", etc.)
            if (typeof dateValue === 'string') {
                let date;
                
                // Try to parse various date formats
                if (dateValue.includes('/')) {
                    // Handle formats like "4/1/25", "04/01/25", "4/1/2025"
                    const parts = dateValue.split('/');
                    if (parts.length === 3) {
                        let month = parseInt(parts[0]);
                        let day = parseInt(parts[1]);
                        let year = parseInt(parts[2]);
                        
                        // Handle 2-digit years (assume 2000s)
                        if (year < 100) {
                            year += 2000;
                        }
                        
                        // Create date (month is 0-indexed in JavaScript)
                        date = new Date(year, month - 1, day);
                    }
                } else {
                    // Try parsing as standard date string
                    date = new Date(dateValue);
                }
                
                if (date && !isNaN(date.getTime())) {
                    // Get the date components to avoid timezone issues
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    
                    return `${year}-${month}-${day}`;
                }
            }
            
            // Fallback to current date
            return new Date().toISOString().split('T')[0];
        }
        
        function downloadXML() {
            try {
                console.log('Download button clicked');
                
                if (!generatedXML || generatedXML.trim() === '') {
                    showMessage('No XML to download. Please generate XML first.', 'error');
                    return;
                }
                
                console.log('XML length:', generatedXML.length);
                
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `minimax_invoices_${timestamp}.xml`;
                
                console.log('Attempting download with filename:', filename);
                
                // Method 1: Modern blob approach
                try {
                    const blob = new Blob([generatedXML], { type: 'application/xml;charset=utf-8' });
                    console.log('Blob created successfully');
                    
                    if (typeof URL !== 'undefined' && URL.createObjectURL) {
                        const url = URL.createObjectURL(blob);
                        console.log('Object URL created');
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        a.style.display = 'none';
                        
                        document.body.appendChild(a);
                        console.log('Triggering download');
                        a.click();
                        
                        // Clean up
                        setTimeout(() => {
                            if (document.body.contains(a)) {
                                document.body.removeChild(a);
                            }
                            URL.revokeObjectURL(url);
                            console.log('Download cleanup completed');
                        }, 1000);
                        
                        showMessage('üéâ XML file downloaded successfully!', 'success');
                        return;
                    }
                } catch (blobError) {
                    console.error('Blob method failed:', blobError);
                }
                
                // Method 2: Data URI fallback
                console.log('Trying data URI fallback method');
                const dataStr = 'data:application/xml;charset=utf-8,' + encodeURIComponent(generatedXML);
                const a = document.createElement('a');
                a.href = dataStr;
                a.download = filename;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    if (document.body.contains(a)) {
                        document.body.removeChild(a);
                    }
                }, 100);
                
                showMessage('üìÅ XML file downloaded (data URI method)!', 'success');
                
            } catch (error) {
                console.error('Download failed:', error);
                showMessage('Download failed: ' + error.message + '. Please try the copy method.', 'error');
                
                // Auto-try copy method as fallback
                setTimeout(() => {
                    copyToClipboard();
                }, 1000);
            }
        }
        
        function copyToClipboard() {
            try {
                if (!generatedXML || generatedXML.trim() === '') {
                    showMessage('No XML to copy. Please generate XML first.', 'error');
                    return;
                }
                
                console.log('Attempting to copy XML to clipboard, length:', generatedXML.length);
                
                // Try modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(generatedXML).then(() => {
                        showMessage('‚úÖ XML copied to clipboard successfully! Paste into text editor and save as .xml file.', 'success');
                        console.log('Copy successful via Clipboard API');
                    }).catch(err => {
                        console.error('Clipboard API failed:', err);
                        fallbackCopyToClipboard();
                    });
                } else {
                    console.log('Clipboard API not available, using fallback');
                    fallbackCopyToClipboard();
                }
                
            } catch (error) {
                console.error('Copy error:', error);
                showMessage('Copy failed. Please use "Preview XML" to manually copy the content.', 'error');
                // Auto-show preview
                setTimeout(() => {
                    togglePreview();
                }, 500);
            }
        }
        
        function fallbackCopyToClipboard() {
            try {
                // Create a temporary textarea
                const textArea = document.createElement('textarea');
                textArea.value = generatedXML;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    showMessage('üìã XML copied to clipboard!', 'success');
                } else {
                    showMessage('Copy failed. Please manually copy from the preview.', 'error');
                    togglePreview(); // Show preview for manual copy
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showMessage('Copy failed. Please manually copy from the preview.', 'error');
                togglePreview(); // Show preview for manual copy
            }
        }
        
        function togglePreview() {
            const preview = document.getElementById('xmlPreview');
            const toggleBtn = document.getElementById('previewToggle');
            
            if (preview.classList.contains('hidden')) {
                if (!generatedXML || generatedXML.trim() === '') {
                    showMessage('No XML to preview. Please generate XML first.', 'error');
                    return;
                }
                
                preview.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>üìÑ Generated XML Preview</h3>
                        <button class="btn btn-success" onclick="selectAllXML()" style="margin: 0;">
                            <span>üìã</span> Select All
                        </button>
                    </div>
                    <div style="background: #f0f0f0; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 0.9rem;">
                        <strong>üìÅ Save as:</strong> minimax_invoices_${new Date().toISOString().split('T')[0]}.xml
                    </div>
                    <pre id="xmlContent" style="user-select: all; cursor: text; background: #fff; border: 2px solid #667eea; max-height: 400px; overflow-y: auto;">${escapeHtml(generatedXML)}</pre>
                `;
                preview.classList.remove('hidden');
                toggleBtn.innerHTML = '<span>üôà</span> Hide Preview';
            } else {
                preview.classList.add('hidden');
                toggleBtn.innerHTML = '<span>üëÅÔ∏è</span> Preview XML';
            }
        }
        
        function selectAllXML() {
            const xmlContent = document.getElementById('xmlContent');
            if (xmlContent) {
                // Create a range and select the content
                const range = document.createRange();
                range.selectNodeContents(xmlContent);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                // Try to copy automatically
                try {
                    document.execCommand('copy');
                    showMessage('üìã XML content selected and copied to clipboard!', 'success');
                } catch (err) {
                    showMessage('üìã XML content selected. Press Ctrl+C to copy.', 'info');
                }
            }
        }
        
        function showProcessing(message) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `
                <div class="processing">
                    <div class="spinner"></div>
                    ${message}
                </div>
            `;
        }
        
        function hideProcessing() {
            const messagesDiv = document.getElementById('messages');
            if (messagesDiv.querySelector('.processing')) {
                messagesDiv.innerHTML = '';
            }
        }
        
        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type}`;
            
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            messageDiv.innerHTML = `${icon} ${message}`;
            
            messagesDiv.innerHTML = '';
            messagesDiv.appendChild(messageDiv);
            
            // Auto-hide after 8 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 8000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function escapeXml(text) {
            if (text === null || text === undefined) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }
    </script>
</body>
</html>