<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimax Invoice XML Converter v2.11 - DDV Book + OSS with Decimal VAT Rates</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #718096;
            font-size: 1.1rem;
        }
        
        .step {
            margin-bottom: 32px;
            padding: 24px;
            background: #f7fafc;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .step h2 {
            color: #667eea;
            margin-bottom: 16px;
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 48px 24px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .file-upload:hover {
            border-color: #5a67d8;
            background: #f7fafc;
            transform: translateY(-2px);
        }
        
        .file-upload.dragover {
            border-color: #5a67d8;
            background: #ebf4ff;
        }
        
        .file-upload-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            color: #667eea;
        }
        
        .file-upload-text {
            font-size: 1.2rem;
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 8px;
        }
        
        .file-upload-hint {
            color: #718096;
            font-size: 0.9rem;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 8px;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #718096, #4a5568);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .setting-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .setting-item label {
            font-weight: 600;
            color: #2d3748;
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        select, input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: white;
        }
        
        select:focus, input[type="text"]:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .preview {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e2e8f0;
        }
        
        .preview pre {
            background: white;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
            border: 1px solid #e2e8f0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }
        
        .alert-error {
            background: #fed7d7;
            color: #c53030;
            border: 1px solid #feb2b2;
        }
        
        .alert-success {
            background: #c6f6d5;
            color: #2f855a;
            border: 1px solid #9ae6b4;
        }
        
        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #90cdf4;
        }
        
        .hidden {
            display: none;
        }
        
        .data-preview {
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .data-preview h3 {
            background: #667eea;
            color: white;
            padding: 12px 16px;
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .table-container {
            max-height: 300px;
            overflow: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        th, td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            text-align: left;
        }
        
        th {
            background: #f7fafc;
            color: #2d3748;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        tbody tr:nth-child(even) {
            background: #f7fafc;
        }
        
        .actions {
            text-align: center;
            margin-top: 32px;
            padding: 24px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            display: block;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            margin-top: 4px;
        }
        
        .info-box {
            background: linear-gradient(135deg, #ebf4ff, #e6fffa);
            border: 1px solid #90cdf4;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .info-box h3 {
            color: #2c5282;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }
        
        .info-box p {
            color: #2d3748;
            line-height: 1.6;
        }
        
        .processing {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        
        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 16px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ Minimax XML Converter</h1>
            <p>Convert your invoice export to Minimax-compatible XML format</p>
            <div style="margin-top: 10px; font-size: 0.85rem; color: #718096;">
                <strong>Version 2.11</strong> | Last updated: <span id="updateTimestamp"></span> | <span style="color: #48bb78;">‚úì DDV Book Support</span> | <span style="color: #48bb78;">‚úì Decimal VAT Rates for OSS</span> | <span style="color: #48bb78;">‚úì ISO Country Codes</span>
            </div>
        </div>
        
        <div class="info-box">
            <h3>‚úÖ Smart Account Selection & VAT Book Integration</h3>
            <p>This converter automatically selects the correct Slovenian accounting codes based on customer country and business type. <strong>Important: Your Excel file must include a "Date due" column</strong> for proper invoice processing. The converter intelligently maps accounts for domestic (Slovenia), EU, and third-country transactions according to Slovenian accounting standards. It also properly handles credit notes (detected from "Type" column) with negative VAT values and includes DDV (VAT) segments for the VAT book.</p>
            <div style="margin-top: 12px; padding: 10px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 6px;">
                <strong style="color: #16a34a;">üÜï New in v2.11:</strong> 
                <ul style="margin: 8px 0 0 20px; line-height: 1.6;">
                    <li><strong>DECIMAL VAT Rates for OSS</strong> - VAT percentages now output with 2 decimal places (20.00, 21.00, 19.00) as required by Minimax</li>
                    <li><strong>Fixed Minimax Import Error</strong> - OSS entries now comply with Minimax XML schema decimal format requirements</li>
                    <li><strong>Schema Compliance</strong> - Odstotek field follows xs:decimal with exactly 2 fraction digits specification</li>
                    <li><strong>Updated Default Accounts</strong> - New default revenue accounts: 7620 (SI), 76301 (EU), 76302 (Third)</li>
                    <li><strong>Corrected Domestic VAT Account</strong> - Slovenia VAT account changed from 26070 to 26000</li>
                    <li><strong>Smart VAT Detection</strong> - Attempts to read VAT rate from Excel headers/data before calculating</li>
                    <li>All previous features: OSS support, DDV book, ISO country codes, hash-based customer codes</li>
                </ul>
            </div>
        </div>
        
        <!-- Step 1: Upload File -->
        <div class="step">
            <h2>üìÅ Step 1: Upload Your Invoice Export</h2>
            <p style="color: #718096; font-size: 0.9rem; margin-bottom: 20px;">
                Required columns: Number, Name, Date, Date due, Total, Total w/ tax<br>
                Optional columns: Type (for credit notes), Tax number, Country, Address, City, Postal code, VAT rate
            </p>
            <div class="file-upload" id="fileUpload">
                <div class="file-upload-icon">üìä</div>
                <div class="file-upload-text">Click or drag and drop your file here</div>
                <div class="file-upload-hint">Supports Excel (.xlsx, .xls) and CSV files up to 30MB</div>
                <input type="file" id="dataFile" accept=".xlsx,.xls,.csv" />
            </div>
            <div id="dataPreview" class="data-preview hidden"></div>
            <div id="dataStats" class="stats hidden"></div>
        </div>
        
        <!-- Step 2: Settings -->
        <div class="step hidden" id="settingsStep">
            <h2>‚öôÔ∏è Step 2: Configure XML Settings</h2>
            <div class="settings-grid">
                <div class="setting-item">
                    <label for="defaultInvoiceType">Document Type</label>
                    <select id="defaultInvoiceType">
                        <option value="IR" selected>IR - Issued Invoice (Izdani Raƒçun)</option>
                        <option value="PR">PR - Received Invoice (Prejeti Raƒçun)</option>
                        <option value="DI">DI - Daily Cash Register (Dnevni Iztr≈æek)</option>
                        <option value="FT">FT - Financial Document</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="businessType">Business Type</label>
                    <select id="businessType">
                        <option value="products" selected>Products (Izdelki)</option>
                        <option value="services">Services (Storitve)</option>
                        <option value="goods">Goods (Blago)</option>
                        <option value="materials">Materials (Material)</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="includeCustomers">Include Customer Data</label>
                    <select id="includeCustomers">
                        <option value="true">Yes - Include customer section</option>
                        <option value="false">No - Only transactions</option>
                    </select>
                    <p style="font-size: 0.8rem; color: #718096; margin-top: 5px;">
                        When set to "No", the SifraStranke field is omitted from journal entries. Minimax will use existing customers based on other data (invoice number, tax ID, etc.).
                    </p>
                </div>
                
                <div class="setting-item" id="customerCodeLogicContainer">
                    <label for="customerCodeLogic">Customer Code Generation</label>
                    <select id="customerCodeLogic">
                        <option value="hash">Use Hash of Name (prevents duplicates)</option>
                        <option value="taxnumber">Use Tax Number (if available)</option>
                        <option value="namebased">Use Name-based code</option>
                        <option value="timestamp">Add timestamp to prefix</option>
                        <option value="manual">Manual prefix only</option>
                    </select>
                </div>
                
                <div class="setting-item" id="customerCodePrefixContainer">
                    <label for="customerCodePrefix">Customer Code Prefix</label>
                    <input type="text" id="customerCodePrefix" value="C" placeholder="e.g., C">
                    <p style="font-size: 0.8rem; color: #718096; margin-top: 5px;">
                        For hash method, prefix is optional. For others, it's added before the code.
                    </p>
                </div>
                
                <div class="setting-item">
                    <label for="homeCountry">Home Country</label>
                    <select id="homeCountry">
                        <option value="Slovenia">Slovenia</option>
                        <option value="Croatia">Croatia</option>
                        <option value="Austria">Austria</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="countryColumn">Country Column</label>
                    <select id="countryColumn">
                        <option value="auto">Auto-detect</option>
                        <option value="Country">Country</option>
                        <option value="Shipping Country">Shipping Country</option>
                        <option value="Billing Country">Billing Country</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="defaultVATRate">Default VAT Rate</label>
                    <select id="defaultVATRate">
                        <option value="S">S - Standard rate 22%</option>
                        <option value="Z">Z - Reduced rate 9.5%</option>
                        <option value="P">P - Special rate 5%</option>
                        <option value="0">0 - Zero rate 0%</option>
                        <option value="OP">OP - Exempt</option>
                        <option value="NE">NE - Not subject to VAT</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="vatRateColumn">VAT Rate Column (Optional)</label>
                    <input type="text" id="vatRateColumn" placeholder="e.g., VAT Rate, Tax Rate">
                </div>
            </div>
            
            <div id="customerWarning" style="margin-top: 20px; padding: 15px; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px;">
                <h3 style="color: #92400e; margin-bottom: 10px;">‚ö†Ô∏è Important: Customer Import</h3>
                <p style="color: #92400e; font-size: 0.9rem; line-height: 1.6;">
                    <strong>Tip:</strong> Use "Hash of Name" method to prevent duplicate customer codes. The same customer name will always generate the same code, so importing the same customer multiple times won't create duplicates in Minimax.
                </p>
                <p style="color: #92400e; font-size: 0.85rem; margin-top: 10px;">
                    Customer code generation options:
                </p>
                <ul style="margin: 8px 0 0 20px; font-size: 0.85rem; color: #92400e;">
                    <li><strong>Hash of Name:</strong> Creates unique 6-8 char code from name (same name = same code)<br>
                        <span style="font-size: 0.8rem; color: #666;">Example: The same customer name will always generate the same code</span></li>
                    <li><strong>Tax Number:</strong> Uses customer's tax ID (good for uniqueness)</li>
                    <li><strong>Name-based:</strong> Creates code from customer name</li>
                    <li><strong>Timestamp:</strong> Adds unique timestamp to prevent duplicates</li>
                    <li><strong>Manual:</strong> Uses your prefix + sequential numbers (may cause duplicates)</li>
                </ul>
            </div>
            
            <div class="info-box" style="margin-top: 20px;">
                <h3>üìä Account Mapping Preview</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #48bb78;">
                        <strong>üá∏üáÆ Slovenia (Domestic)</strong><br>
                        <small id="domesticPreview">Receivables: 1200 | Revenue: 7620 | VAT: 26000</small>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #4299e1;">
                        <strong>üá™üá∫ EU Countries</strong><br>
                        <small id="euPreview">Receivables: 1211 | Revenue: 76301 | VAT: 26071 (OSS)</small>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #ed8936;">
                        <strong>üåç Third Countries</strong><br>
                        <small id="thirdPreview">Receivables: 1210 | Revenue: 76302 | VAT: No VAT</small>
                    </div>
                </div>
                <p style="margin-top: 15px; font-size: 0.9rem; color: #718096;">Revenue accounts automatically selected based on business type and customer country. You can override these below.</p>
            </div>
            
            <div style="margin-top: 20px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">üîß Manual Account Overrides (Optional)</h3>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>üá∏üáÆ Domestic Receivables</label>
                        <input type="text" id="domesticReceivables" placeholder="Auto: 1200">
                    </div>
                    <div class="setting-item">
                        <label>üá∏üáÆ Domestic Revenue</label>
                        <input type="text" id="domesticRevenue" placeholder="Auto: Based on business type">
                    </div>
                    <div class="setting-item">
                        <label>üá∏üáÆ Domestic VAT</label>
                        <input type="text" id="domesticVAT" placeholder="Auto: 26000">
                    </div>
                    
                    <div class="setting-item">
                        <label>üá™üá∫ EU Receivables</label>
                        <input type="text" id="euReceivables" placeholder="Auto: 1211">
                    </div>
                    <div class="setting-item">
                        <label>üá™üá∫ EU Revenue</label>
                        <input type="text" id="euRevenue" placeholder="Auto: Based on business type">
                    </div>
                    <div class="setting-item">
                        <label>üá™üá∫ EU VAT</label>
                        <input type="text" id="euVAT" placeholder="Auto: 26071 (OSS)">
                    </div>
                    
                    <div class="setting-item">
                        <label>üåç Third Country Receivables</label>
                        <input type="text" id="thirdReceivables" placeholder="Auto: 1210">
                    </div>
                    <div class="setting-item">
                        <label>üåç Third Country Revenue</label>
                        <input type="text" id="thirdRevenue" placeholder="Auto: Based on business type">
                    </div>
                    <div class="setting-item">
                        <label>üåç Third Country VAT</label>
                        <input type="text" id="thirdVAT" placeholder="Auto: No VAT (leave empty)">
                    </div>
                </div>
                <p style="margin-top: 15px; font-size: 0.9rem; color: #718096;">Leave fields empty to use automatic selection. Fill in to override specific accounts.</p>
            </div>
        </div>
        
        <!-- Step 3: Generate XML -->
        <div class="step hidden" id="xmlStep">
            <h2>üöÄ Step 3: Generate and Download XML</h2>
            <div class="actions">
                <button class="btn" id="generateBtn" onclick="generateXML()">
                    <span>üìÑ</span> Generate Minimax XML
                </button>
                <button class="btn btn-success hidden" id="downloadBtn" onclick="downloadXML()">
                    <span>‚¨áÔ∏è</span> Download XML File
                </button>
                <button class="btn btn-secondary hidden" id="copyBtn" onclick="copyToClipboard()">
                    <span>üìã</span> Copy to Clipboard
                </button>
                <button class="btn btn-secondary hidden" id="previewToggle" onclick="togglePreview()">
                    <span>üëÅÔ∏è</span> Preview XML
                </button>
            </div>
            <div id="downloadInfo" class="hidden" style="margin-top: 15px; padding: 15px; background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 8px; font-size: 0.9rem;">
                <strong>üí° Multiple Options:</strong>
                <ul style="margin: 10px 0 0 20px; line-height: 1.6;">
                    <li><strong>Download:</strong> Direct file download (works in most browsers)</li>
                    <li><strong>Copy:</strong> Copy to clipboard, then paste in text editor and save as .xml</li>
                    <li><strong>Preview:</strong> View XML content for manual copying</li>
                </ul>
            </div>
            <div id="xmlPreview" class="preview hidden"></div>
        </div>
        
        <div id="messages"></div>
        
        <div style="text-align: center; margin-top: 40px; padding: 20px; border-top: 1px solid #e2e8f0;">
            <p style="color: #718096; font-size: 0.85rem;">
                <strong>Minimax XML Converter v2.11</strong> | Features: IR Journal Entries + DDV Book + Decimal OSS VAT Rates<br>
                <span style="color: #48bb78;">‚úì</span> Decimal VAT rates for OSS (xx.xx format) | 
                <span style="color: #48bb78;">‚úì</span> DDV/VAT book entries | 
                <span style="color: #48bb78;">‚úì</span> Credit notes with negative VAT | 
                <span style="color: #48bb78;">‚úì</span> Smart country detection |
                <span style="color: #48bb78;">‚úì</span> Hash-based duplicate prevention |
                <span style="color: #48bb78;">‚úì</span> ISO country codes
            </p>
        </div>
    </div>

    <script>
        // Version information
        console.log('Minimax XML Converter v2.11 loaded');
        console.log('Features: DDV Book Support, Credit Notes, Smart Account Selection, Hash-based Customer Codes, ISO Country Codes, Decimal VAT Rates for OSS');
        console.log('Last updated: June 25, 2025');
        
        // Fixed timestamp when code was generated
        function updateTimestamp() {
            const timestamp = "June 25, 2025 at 12:30 PM";
            const timestampElement = document.getElementById('updateTimestamp');
            if (timestampElement) {
                timestampElement.textContent = timestamp;
            }
        }
        
        // Standard EU VAT rates (as of 2025)
        const EU_VAT_RATES = {
            'AT': 20,    // Austria
            'BE': 21,    // Belgium
            'BG': 20,    // Bulgaria
            'HR': 25,    // Croatia
            'CY': 19,    // Cyprus
            'CZ': 21,    // Czech Republic
            'DK': 25,    // Denmark
            'EE': 22,    // Estonia (increased from 20)
            'FI': 25.5,  // Finland (increased from 24)
            'FR': 20,    // France
            'DE': 19,    // Germany
            'GR': 24,    // Greece
            'HU': 27,    // Hungary
            'IE': 23,    // Ireland
            'IT': 22,    // Italy
            'LV': 21,    // Latvia
            'LT': 21,    // Lithuania
            'LU': 17,    // Luxembourg
            'MT': 18,    // Malta
            'NL': 21,    // Netherlands
            'PL': 23,    // Poland
            'PT': 23,    // Portugal
            'RO': 19,    // Romania
            'SK': 20,    // Slovakia
            'SI': 22,    // Slovenia
            'ES': 21,    // Spain
            'SE': 25     // Sweden
        };
        
        // Simple hash function to create consistent short codes
        function simpleHash(str) {
            let hash = 0;
            let hash2 = 0;
            
            // Use two different hash calculations for better distribution
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
                
                // Second hash using different multiplier
                hash2 = ((hash2 << 3) + hash2) + char;
                hash2 = hash2 & hash2;
            }
            
            // Combine both hashes for better uniqueness
            const combined = Math.abs(hash) + Math.abs(hash2);
            
            // Convert to base36 for alphanumeric code (0-9, A-Z)
            let code = combined.toString(36).toUpperCase();
            
            // Ensure minimum length and pad if needed
            while (code.length < 6) {
                code = '0' + code;
            }
            
            // Return first 8 characters (or full code if shorter)
            return code.substring(0, 8);
        }
        
        // Show version notification on load
        window.addEventListener('DOMContentLoaded', function() {
            updateTimestamp();
            showMessage('‚úÖ Minimax XML Converter v2.11 loaded - Decimal VAT rates (xx.xx format) for OSS compliance', 'info');
            
            // Test hash function examples
            console.log('Hash function examples (same name always produces same code):');
            console.log('  "ACME Corp" ‚Üí "' + simpleHash('ACME Corp'.toUpperCase()) + '"');
            console.log('  "John Smith Ltd" ‚Üí "' + simpleHash('John Smith Ltd'.toUpperCase()) + '"');
            console.log('  "Test Company" ‚Üí "' + simpleHash('Test Company'.toUpperCase()) + '"');
            console.log('  "ABC Inc" ‚Üí "' + simpleHash('ABC Inc'.toUpperCase()) + '"');
            console.log('  "XYZ Solutions" ‚Üí "' + simpleHash('XYZ Solutions'.toUpperCase()) + '"');
            console.log('Note: Importing the same customer multiple times will use the same code.');
        });
        
        let invoiceData = [];
        let generatedXML = '';
        let columnHeaders = {}; // Store column headers
        
        // File upload handling
        document.getElementById('dataFile').addEventListener('change', handleFileSelect);
        
        const fileUpload = document.getElementById('fileUpload');
        fileUpload.addEventListener('click', () => document.getElementById('dataFile').click());
        fileUpload.addEventListener('dragover', handleDragOver);
        fileUpload.addEventListener('drop', handleFileDrop);
        fileUpload.addEventListener('dragenter', e => e.preventDefault());
        fileUpload.addEventListener('dragleave', e => fileUpload.classList.remove('dragover'));
        
        function handleDragOver(e) {
            e.preventDefault();
            fileUpload.classList.add('dragover');
        }
        
        function handleFileDrop(e) {
            e.preventDefault();
            fileUpload.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }
        
        function processFile(file) {
            if (file.size > 30 * 1024 * 1024) {
                showMessage('File size exceeds 30MB limit. Please use a smaller file.', 'error');
                return;
            }
            
            showProcessing('Reading file...');
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileExtension === 'csv') {
                processCSV(file);
            } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                processExcel(file);
            } else {
                hideProcessing();
                showMessage('Please upload a CSV or Excel file (.csv, .xlsx, .xls)', 'error');
            }
        }
        
        function processCSV(file) {
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    hideProcessing();
                    if (results.errors.length > 0) {
                        showMessage('Error parsing CSV: ' + results.errors[0].message, 'error');
                        return;
                    }
                    
                    invoiceData = results.data;
                    displayDataPreview();
                    showSettings();
                    showMessage(`‚úÖ CSV file loaded successfully! Found ${invoiceData.length} records.`, 'success');
                },
                error: function(error) {
                    hideProcessing();
                    showMessage('Error reading CSV file: ' + error.message, 'error');
                }
            });
        }
        
        function processExcel(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Extract headers to check for VAT rate info
                    const range = XLSX.utils.decode_range(worksheet['!ref']);
                    columnHeaders = {};
                    
                    for (let col = range.s.c; col <= range.e.c; col++) {
                        const headerCell = worksheet[XLSX.utils.encode_cell({r: 0, c: col})];
                        if (headerCell && headerCell.v) {
                            const headerText = String(headerCell.v);
                            // Store the column letter for each header
                            const colLetter = XLSX.utils.encode_col(col);
                            columnHeaders[headerText] = colLetter;
                            
                            // Check if header contains VAT percentage info
                            const vatMatch = headerText.match(/(\d+(?:\.\d+)?)\s*%/);
                            if (vatMatch) {
                                console.log(`Found VAT rate in header "${headerText}": ${vatMatch[1]}%`);
                            }
                        }
                    }
                    
                    // Convert to JSON with proper date handling
                    invoiceData = XLSX.utils.sheet_to_json(worksheet, {
                        raw: false,
                        dateNF: 'yyyy-mm-dd'
                    });
                    
                    // Clean up and process data
                    invoiceData = invoiceData.map(row => {
                        const cleanRow = {};
                        Object.keys(row).forEach(key => {
                            if (key && key.trim() !== '') {
                                cleanRow[key] = row[key];
                            }
                        });
                        return cleanRow;
                    }).filter(row => Object.keys(row).length > 0);
                    
                    hideProcessing();
                    displayDataPreview();
                    showSettings();
                    showMessage(`‚úÖ Excel file loaded successfully! Found ${invoiceData.length} records.`, 'success');
                    
                } catch (error) {
                    hideProcessing();
                    showMessage('Error reading Excel file: ' + error.message, 'error');
                }
            };
            reader.onerror = function() {
                hideProcessing();
                showMessage('Error reading file. Please try again.', 'error');
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Function to extract VAT rate from column header or data
        function getVATRateFromData(row, columnHeaders) {
            // Check if any column header contains VAT percentage
            for (const [header, colLetter] of Object.entries(columnHeaders)) {
                const vatMatch = header.match(/(\d+(?:\.\d+)?)\s*%/);
                if (vatMatch) {
                    return parseFloat(vatMatch[1]);
                }
            }
            
            // Check data for VAT rate information
            const vatRateColumn = document.getElementById('vatRateColumn').value.trim();
            if (vatRateColumn && row[vatRateColumn]) {
                const vatValue = String(row[vatRateColumn]);
                // Try to extract percentage from value
                const match = vatValue.match(/(\d+(?:\.\d+)?)/);
                if (match) {
                    return parseFloat(match[1]);
                }
            }
            
            return null;
        }
        
        // Function to round VAT rate to nearest standard EU rate
        function roundToStandardVATRate(calculatedRate, countryCode) {
            // First check if we have a specific rate for this country
            if (countryCode && EU_VAT_RATES[countryCode]) {
                return EU_VAT_RATES[countryCode];
            }
            
            // All EU standard VAT rates for rounding
            const allStandardRates = [...new Set(Object.values(EU_VAT_RATES))].sort((a, b) => a - b);
            
            // Find the closest standard rate
            let closestRate = allStandardRates[0];
            let minDiff = Math.abs(calculatedRate - closestRate);
            
            for (const rate of allStandardRates) {
                const diff = Math.abs(calculatedRate - rate);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestRate = rate;
                }
            }
            
            // If the difference is less than 0.5%, use the standard rate
            if (minDiff < 0.5) {
                return closestRate;
            }
            
            // Otherwise, round to nearest 0.5%
            return Math.round(calculatedRate * 2) / 2;
        }
        
        function displayDataPreview() {
            if (invoiceData.length === 0) return;
            
            const preview = document.getElementById('dataPreview');
            const stats = document.getElementById('dataStats');
            
            // Calculate statistics
            const totalInvoices = invoiceData.length;
            const totalAmount = invoiceData.reduce((sum, row) => {
                const amount = parseFloat(row['Total w/ tax'] || row['Total'] || 0);
                return sum + (isNaN(amount) ? 0 : amount);
            }, 0);
            
            const uniqueCustomers = new Set();
            invoiceData.forEach(row => {
                if (row['Name']) uniqueCustomers.add(row['Name']);
            });
            
            const paidInvoices = invoiceData.filter(row => 
                row['Paid'] && row['Paid'].toString().toLowerCase() === 'yes'
            ).length;
            
            // Display statistics
            stats.innerHTML = `
                <div class="stat-item">
                    <span class="stat-value">${totalInvoices}</span>
                    <div class="stat-label">Total Invoices</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${uniqueCustomers.size}</span>
                    <div class="stat-label">Unique Customers</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${paidInvoices}</span>
                    <div class="stat-label">Paid Invoices</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${totalAmount.toFixed(2)}</span>
                    <div class="stat-label">Total Amount</div>
                </div>
            `;
            
            // Display data preview
            const headers = Object.keys(invoiceData[0]);
            const maxRows = 5;
            
            let html = '<h3>üìä Data Preview (first ' + maxRows + ' rows)</h3>';
            html += '<div class="table-container"><table>';
            html += '<thead><tr>' + headers.map(h => '<th>' + escapeHtml(h) + '</th>').join('') + '</tr></thead>';
            html += '<tbody>';
            
            for (let i = 0; i < Math.min(maxRows, invoiceData.length); i++) {
                html += '<tr>';
                headers.forEach(header => {
                    const value = invoiceData[i][header];
                    html += '<td>' + escapeHtml(String(value || '')) + '</td>';
                });
                html += '</tr>';
            }
            html += '</tbody></table></div>';
            
            preview.innerHTML = html;
            preview.classList.remove('hidden');
            stats.classList.remove('hidden');
        }
        
        function showSettings() {
            document.getElementById('settingsStep').classList.remove('hidden');
            document.getElementById('xmlStep').classList.remove('hidden');
            
            // Add event listeners for preview updates
            document.getElementById('businessType').addEventListener('change', updateAccountPreview);
            
            // Add event listener for customer inclusion toggle
            document.getElementById('includeCustomers').addEventListener('change', function(e) {
                const showCustomerOptions = e.target.value === 'true';
                document.getElementById('customerCodeLogicContainer').style.display = showCustomerOptions ? 'block' : 'none';
                document.getElementById('customerCodePrefixContainer').style.display = showCustomerOptions ? 'block' : 'none';
                document.getElementById('customerWarning').style.display = showCustomerOptions ? 'block' : 'none';
            });
            
            // Add event listeners for manual override fields
            const overrideFields = [
                'domesticReceivables', 'domesticRevenue', 'domesticVAT',
                'euReceivables', 'euRevenue', 'euVAT',
                'thirdReceivables', 'thirdRevenue', 'thirdVAT'
            ];
            
            overrideFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateAccountPreview);
                }
            });
            
            // Initial preview update
            updateAccountPreview();
        }
        
        function generateXML() {
            try {
                if (invoiceData.length === 0) {
                    showMessage('No data to process. Please upload a file first.', 'error');
                    return;
                }
                
                showProcessing('Generating XML...');
                
                // Small delay to show processing
                setTimeout(() => {
                    try {
                        generatedXML = createMinimaxXML(invoiceData);
                        
                        if (!generatedXML || generatedXML.trim() === '') {
                            throw new Error('Generated XML is empty');
                        }
                        
                        hideProcessing();
                        
                        // Show all action buttons
                        document.getElementById('downloadBtn').classList.remove('hidden');
                        document.getElementById('copyBtn').classList.remove('hidden');
                        document.getElementById('previewToggle').classList.remove('hidden');
                        document.getElementById('downloadInfo').classList.remove('hidden');
                        
                        // Count how many invoices have DDV segments
                        let ddvCount = 0;
                        let vatInvoicesCount = 0;
                        let ossCount = 0;
                        
                        const settings = {
                            invoiceType: document.getElementById('defaultInvoiceType').value,
                            homeCountry: document.getElementById('homeCountry').value,
                            countryColumn: document.getElementById('countryColumn').value,
                            includeCustomers: document.getElementById('includeCustomers').value === 'true'
                        };
                        
                        invoiceData.forEach(row => {
                            const netAmount = parseFloat(row['Total'] || 0);
                            const grossAmount = parseFloat(row['Total w/ tax'] || netAmount);
                            const taxAmount = grossAmount - netAmount;
                            const customerCountry = getCustomerCountry(row, settings.countryColumn);
                            const countryType = classifyCountry(customerCountry, settings.homeCountry);
                            
                            if (Math.abs(taxAmount) > 0.001 && countryType !== 'third') {
                                vatInvoicesCount++;
                                if (settings.invoiceType === 'IR') {
                                    ddvCount++;
                                    if (countryType === 'eu') {
                                        ossCount++;
                                    }
                                }
                            }
                        });
                        
                        let message = `üéâ XML generated successfully! Created ${invoiceData.length} ${settings.invoiceType} records`;
                        
                        if (settings.includeCustomers) {
                            const uniqueCustomers = new Map();
                            invoiceData.forEach(row => {
                                if (row['Name']) uniqueCustomers.set(row['Name'], true);
                            });
                            message += ` with ${uniqueCustomers.size} unique customers`;
                        } else {
                            message += ` (customers not included)`;
                        }
                        
                        if (settings.invoiceType === 'IR' && ddvCount > 0) {
                            message += ` and ${ddvCount} DDV book entries`;
                            if (ossCount > 0) {
                                message += ` (${ossCount} with OSS)`;
                            }
                        } else if (settings.invoiceType !== 'IR' && vatInvoicesCount > 0) {
                            message += ` (Note: DDV segments only included for IR type)`;
                        }
                        message += ` (${(generatedXML.length / 1024).toFixed(1)} KB)`;
                        
                        showMessage(message, 'success');
                        
                    } catch (error) {
                        hideProcessing();
                        showMessage('Error generating XML: ' + error.message, 'error');
                        console.error('XML Generation Error:', error);
                    }
                }, 100);
                
            } catch (error) {
                hideProcessing();
                showMessage('Error generating XML: ' + error.message, 'error');
                console.error('XML Generation Error:', error);
            }
        }
        
        function createMinimaxXML(data) {
            const settings = {
                invoiceType: document.getElementById('defaultInvoiceType').value,
                businessType: document.getElementById('businessType').value,
                includeCustomers: document.getElementById('includeCustomers').value === 'true',
                customerCodePrefix: document.getElementById('customerCodePrefix').value || 'C',
                customerCodeLogic: document.getElementById('customerCodeLogic').value || 'hash',
                homeCountry: document.getElementById('homeCountry').value,
                countryColumn: document.getElementById('countryColumn').value,
                defaultVATRate: document.getElementById('defaultVATRate').value || 'S',
                vatRateColumn: document.getElementById('vatRateColumn').value.trim()
            };
            
            // Function to generate unique customer code
            function generateCustomerCode(customer, index, settings) {
                switch (settings.customerCodeLogic) {
                    case 'hash':
                        // Use hash of customer name for consistent codes
                        if (customer.name) {
                            const hash = simpleHash(customer.name.trim().toUpperCase());
                            // Add optional prefix
                            return settings.customerCodePrefix ? settings.customerCodePrefix + hash : hash;
                        }
                        // Fall through to timestamp if no name
                        /* falls through */
                        
                    case 'taxnumber':
                        // Use tax number if available, otherwise fall back to name-based
                        if (customer.taxNumber && customer.taxNumber.trim()) {
                            // Remove common prefixes like SI, AT, DE etc.
                            return customer.taxNumber.replace(/^[A-Z]{2}/i, '').trim();
                        }
                        // Fall through to name-based if no tax number
                        /* falls through */
                        
                    case 'namebased':
                        // Create code from customer name (first 10 chars, uppercase, no spaces)
                        if (customer.name) {
                            const nameCode = customer.name
                                .toUpperCase()
                                .replace(/[^A-Z0-9]/g, '') // Remove non-alphanumeric
                                .substring(0, 20); // Limit to 20 chars
                            if (nameCode) return nameCode;
                        }
                        // Fall through to timestamp if no valid name code
                        /* falls through */
                        
                    case 'timestamp':
                        // Add timestamp to make unique
                        const timestamp = new Date().getTime().toString(36).toUpperCase();
                        return settings.customerCodePrefix + timestamp + '_' + (index + 1);
                        
                    case 'manual':
                    default:
                        // Use prefix with index
                        return settings.customerCodePrefix + (index + 1).toString().padStart(3, '0');
                }
            }
            
            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xml += '<!-- Generated by Minimax XML Converter v2.11 - DDV Book + Decimal OSS VAT Rates + ISO Country Codes -->\n';
            xml += '<miniMAXUvozKnjigovodstvo xmlns="https://moj.minimax.si/SI/CommonWeb/documents/schemas/miniMAXUvozKnjigovodstvo" ';
            xml += 'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" ';
            xml += 'xsi:schemaLocation="https://moj.minimax.si/SI/CommonWeb/documents/schemas/miniMAXUvozKnjigovodstvo ';
            xml += 'https://moj.minimax.si/SI/CommonWeb/documents/schemas/miniMAXUvozKnjigovodstvo.xsd">\n';
            
            // Extract unique customers if enabled
            const customerMap = new Map(); // Map to track unique customers
            
            if (settings.includeCustomers) {
                data.forEach((row, index) => {
                    const customerName = row['Name'];
                    if (customerName && !customerMap.has(customerName)) {
                        const country = getCustomerCountry(row, settings.countryColumn);
                        const customer = {
                            name: customerName,
                            address: row['Address'] || '',
                            postalCode: row['Postal code'] || '',
                            city: row['City'] || '',
                            country: country,
                            taxNumber: row['Tax number'] || ''
                        };
                        
                        // Generate unique code for this customer
                        const customerCode = generateCustomerCode(customer, customerMap.size, settings);
                        customer.code = customerCode;
                        
                        customerMap.set(customerName, customer);
                    }
                });
                
                // Add customers section following exact schema order
                if (customerMap.size > 0) {
                    xml += '  <Stranke>\n';
                    customerMap.forEach(customer => {
                        xml += '    <Stranka>\n';
                        xml += `      <Sifra>${escapeXml(customer.code)}</Sifra>\n`;
                        xml += `      <Naziv>${escapeXml(customer.name)}</Naziv>\n`;
                        // Following exact schema sequence order
                        if (customer.address) {
                            xml += `      <Naslov>${escapeXml(customer.address)}</Naslov>\n`;
                        }
                        if (customer.country) {
                            // Convert country name to ISO code for better compatibility
                            const countryCode = COUNTRY_CODES[customer.country] || customer.country;
                            xml += `      <KraticaDrzave>${escapeXml(countryCode)}</KraticaDrzave>\n`;
                        }
                        if (customer.postalCode) {
                            xml += `      <PostnaStevilka>${escapeXml(customer.postalCode)}</PostnaStevilka>\n`;
                        }
                        if (customer.city) {
                            xml += `      <NazivPoste>${escapeXml(customer.city)}</NazivPoste>\n`;
                        }
                        // Add DavcniZavezanec before IdentifikacijskaStevilka as per schema
                        if (customer.taxNumber) {
                            xml += `      <DavcniZavezanec>D</DavcniZavezanec>\n`;
                            xml += `      <IdentifikacijskaStevilka>${escapeXml(customer.taxNumber)}</IdentifikacijskaStevilka>\n`;
                        }
                        xml += '    </Stranka>\n';
                    });
                    xml += '  </Stranke>\n';
                }
            }
            
            // Add invoices section following exact schema structure
            xml += '  <Temeljnice>\n';
            data.forEach((row, index) => {
                const netAmount = parseFloat(row['Total'] || 0);
                const grossAmount = parseFloat(row['Total w/ tax'] || netAmount);
                const taxAmount = grossAmount - netAmount;
                
                // Get customer code from map if customers are included
                let customerCode = '';
                if (settings.includeCustomers && row['Name'] && customerMap.has(row['Name'])) {
                    customerCode = customerMap.get(row['Name']).code;
                }
                
                // Check if this is a credit note
                const isCreditNote = row['Type'] && row['Type'].toString().toLowerCase().includes('credit');
                const documentPrefix = isCreditNote ? 'Credit note' : 'Invoice';
                
                // Get customer country and determine accounts
                const customerCountry = getCustomerCountry(row, settings.countryColumn);
                const countryType = classifyCountry(customerCountry, settings.homeCountry);
                const accounts = getAccountsByCountryType(countryType, settings.businessType);
                
                // Get country ISO code
                const countryISO = COUNTRY_CODES[customerCountry] || customerCountry;
                
                // Debug for first record
                if (index === 0) {
                    console.log('=== Minimax XML Converter v2.11 Debug Info ===');
                    console.log('Account selection for first record:');
                    console.log('Customer:', row['Name']);
                    console.log('Customer code:', customerCode || 'Not included');
                    console.log('Customer code logic:', settings.customerCodeLogic);
                    if (settings.customerCodeLogic === 'hash' && row['Name']) {
                        console.log('Hash code generated:', simpleHash(row['Name'].trim().toUpperCase()));
                    }
                    console.log('Customer country:', customerCountry);
                    console.log('Country code (ISO):', countryISO);
                    console.log('Country type:', countryType);
                    console.log('Document type:', isCreditNote ? 'Credit Note' : 'Invoice');
                    console.log('Selected accounts:');
                    console.log('  Receivables:', accounts.receivables);
                    console.log('  Revenue:', accounts.revenue);
                    console.log('  VAT:', accounts.vat || 'No VAT');
                    console.log('DDV segment:', Math.abs(taxAmount) > 0.001 && accounts.vat && countryType !== 'third' && settings.invoiceType === 'IR' ? 'Will be included' : 'Not included');
                    console.log('OSS journal entry:', countryType === 'eu' && Math.abs(taxAmount) > 0.001 && settings.invoiceType === 'IR' ? 'Will use ZnesekOsnoveVDenarniEnoti for revenue with DECIMAL VAT % (xx.xx format)' : 'Standard entry');
                    console.log('==========================================');
                }
                
                xml += '    <Temeljnica>\n';
                
                // GlavaTemeljnice section (required structure)
                xml += '      <GlavaTemeljnice>\n';
                xml += `        <SifraVrsteTemeljnice>${escapeXml(settings.invoiceType)}</SifraVrsteTemeljnice>\n`;
                xml += `        <DatumTemeljnice>${formatDate(row['Date'])}</DatumTemeljnice>\n`;
                xml += `        <OpisGlaveTemeljnice>${escapeXml(row['Number'] || documentPrefix + ' ' + (index + 1))}</OpisGlaveTemeljnice>\n`;
                xml += '      </GlavaTemeljnice>\n';
                
                // DDV section for VAT book entries (only for invoices with VAT)
                // This section must be included for the DDV book to appear in Minimax
                if (Math.abs(taxAmount) > 0.001 && accounts.vat && countryType !== 'third' && settings.invoiceType === 'IR') {
                    xml += '      <DDV>\n';
                    xml += '        <DDVVrstica>\n';
                    xml += '          <DDVGlava>\n';
                    xml += `            <DatumDDV>${formatDate(row['Date'])}</DatumDDV>\n`;
                    xml += '            <KnjigaDDV>IR</KnjigaDDV>\n'; // IR = Knjiga izdanih raƒçunov
                    xml += `            <DatumKnjizenjaDDV>${formatDate(row['Date'])}</DatumKnjizenjaDDV>\n`;
                    if (customerCode) {
                        xml += `            <SifraStranke>${escapeXml(customerCode)}</SifraStranke>\n`;
                    }
                    xml += `            <Listina>${escapeXml(row['Number'] || 'IR:' + formatDate(row['Date']) + '-' + (index + 1))}</Listina>\n`;
                    xml += `            <DatumListine>${formatDate(row['Date'])}</DatumListine>\n`;
                    xml += '          </DDVGlava>\n';
                    xml += '          <DDVStopnje>\n';
                    xml += '            <DDVStopnja>\n';
                    
                    // Determine VAT rate code
                    let vatRateCode = settings.defaultVATRate;
                    
                    // Check if there's a VAT rate column in the data
                    if (settings.vatRateColumn && row[settings.vatRateColumn]) {
                        const rowVatRate = row[settings.vatRateColumn].toString().toUpperCase();
                        // Map common values to VAT rate codes
                        if (rowVatRate === 'S' || rowVatRate.includes('22') || rowVatRate.includes('STANDARD')) {
                            vatRateCode = 'S';
                        } else if (rowVatRate === 'Z' || rowVatRate.includes('9.5') || rowVatRate.includes('REDUCED')) {
                            vatRateCode = 'Z';
                        } else if (rowVatRate === 'P' || rowVatRate.includes('5') || rowVatRate.includes('SPECIAL')) {
                            vatRateCode = 'P';
                        } else if (rowVatRate === '0' || rowVatRate.includes('ZERO')) {
                            vatRateCode = '0';
                        } else if (rowVatRate === 'OP' || rowVatRate.includes('EXEMPT')) {
                            vatRateCode = 'OP';
                        } else if (rowVatRate === 'NE' || rowVatRate.includes('NOT SUBJECT')) {
                            vatRateCode = 'NE';
                        }
                    }
                    
                    xml += `              <SifraStopnjeDDV>${vatRateCode}</SifraStopnjeDDV>\n`;
                    
                    // For services vs goods, use appropriate fields
                    // Note: DDV book typically shows absolute values
                    if (settings.businessType === 'services') {
                        xml += `              <StoritevOsnova>${Math.abs(netAmount).toFixed(2)}</StoritevOsnova>\n`;
                        xml += `              <StoritevDDV>${Math.abs(taxAmount).toFixed(2)}</StoritevDDV>\n`;
                    } else {
                        xml += `              <Osnova>${Math.abs(netAmount).toFixed(2)}</Osnova>\n`;
                        xml += `              <DDV>${Math.abs(taxAmount).toFixed(2)}</DDV>\n`;
                    }
                    
                    xml += '            </DDVStopnja>\n';
                    xml += '          </DDVStopnje>\n';
                    xml += '        </DDVVrstica>\n';
                    xml += '      </DDV>\n';
                }
                
                // VrsticeTemeljnice section (correct structure from schema)
                xml += '      <VrsticeTemeljnice>\n';
                
                const invoiceDate = formatDate(row['Date']);
                const dueDate = formatDate(row['Date due']); // Use the Date due column from Excel
                
                // Debug dates for first record
                if (index === 0) {
                    console.log('First record dates:');
                    console.log('Raw invoice date from Excel:', row['Date'], '(Type:', typeof row['Date'], ')');
                    console.log('Raw due date from Excel:', row['Date due'], '(Type:', typeof row['Date due'], ')');
                    console.log('Formatted invoice date:', invoiceDate);
                    console.log('Formatted due date:', dueDate);
                }
                
                // Receivables entry (debit) - following exact schema sequence
                xml += '        <VrsticaTemeljnice>\n';
                xml += `          <OpisVrsticeTemeljnice>${documentPrefix} ${escapeXml(row['Number'] || '')} - ${escapeXml(row['Name'] || '')}</OpisVrsticeTemeljnice>\n`;
                xml += `          <SifraKonta>${escapeXml(accounts.receivables)}</SifraKonta>\n`;
                if (customerCode) {
                    xml += `          <SifraStranke>${escapeXml(customerCode)}</SifraStranke>\n`;
                }
                // Add required dates for account 1200/1210/1211
                xml += `          <DatumZapadlosti>${dueDate}</DatumZapadlosti>\n`;
                xml += `          <DatumOpravljanja>${invoiceDate}</DatumOpravljanja>\n`;
                if (row['Reference']) {
                    xml += `          <VezaZaPlacilo>${escapeXml(row['Reference'])}</VezaZaPlacilo>\n`;
                }
                xml += `          <ZnesekVBremeVDomaciDenarniEnoti>${grossAmount.toFixed(2)}</ZnesekVBremeVDomaciDenarniEnoti>\n`;
                xml += '        </VrsticaTemeljnice>\n';
                
                // Revenue entry (credit) - following exact schema sequence
                xml += '        <VrsticaTemeljnice>\n';
                xml += `          <OpisVrsticeTemeljnice>Revenue - ${escapeXml(row['Number'] || '')}</OpisVrsticeTemeljnice>\n`;
                xml += `          <SifraKonta>${escapeXml(accounts.revenue)}</SifraKonta>\n`;
                xml += `          <DatumOpravljanja>${invoiceDate}</DatumOpravljanja>\n`;
                
                // IMPORTANT: Always include the standard amount fields for journal entry
                xml += `          <ZnesekVDobroVDomaciDenarniEnoti>${Math.abs(netAmount).toFixed(2)}</ZnesekVDobroVDomaciDenarniEnoti>\n`;
                
                // Add OSS fields for EU transactions with VAT
                if (countryType === 'eu' && Math.abs(taxAmount) > 0.001 && settings.invoiceType === 'IR') {
                    xml += '          <PredlozitevObracunaOSS>D</PredlozitevObracunaOSS>\n'; // D = Da (Yes)
                    
                    // Use ISO country code
                    xml += `          <Drzava>${escapeXml(countryISO)}</Drzava>\n`;
                    
                    // Calculate VAT percentage from amounts
                    let vatPercent = netAmount !== 0 ? Math.abs((taxAmount / netAmount) * 100) : 0;
                    
                    // Try to get VAT rate from data first
                    const dataVatRate = getVATRateFromData(row, columnHeaders);
                    if (dataVatRate !== null) {
                        vatPercent = dataVatRate;
                        console.log(`Row ${index + 1}: Using VAT rate from data: ${vatPercent}%. Will output as decimal: ${vatPercent.toFixed(2)}`);
                    } else {
                        // Round to standard EU VAT rate
                        const originalPercent = vatPercent;
                        vatPercent = roundToStandardVATRate(vatPercent, countryISO);
                        if (originalPercent !== vatPercent) {
                            console.log(`Row ${index + 1}: Rounded VAT from ${originalPercent.toFixed(2)}% to ${vatPercent}% (standard rate for ${countryISO || 'EU'}). Will output as decimal: ${vatPercent.toFixed(2)}`);
                        }
                    }
                    
                    xml += `          <Odstotek>${vatPercent.toFixed(2)}</Odstotek>\n`;
                    
                    // Set goods/services type - use capital first letter as per documentation
                    const goodsServices = settings.businessType === 'services' ? 'Storitev' : 'Blago';
                    xml += `          <BlagoStoritev>${goodsServices}</BlagoStoritev>\n`;
                    xml += `          <DatumDDV>${invoiceDate}</DatumDDV>\n`;
                    
                    // IMPORTANT: For OSS entries, ALSO include the base amount field (in addition to the standard amount above)
                    xml += `          <ZnesekOsnoveVDomaciDenarniEnoti>${Math.abs(netAmount).toFixed(2)}</ZnesekOsnoveVDomaciDenarniEnoti>\n`;
                }
                
                xml += '        </VrsticaTemeljnice>\n';
                
                // VAT entry if applicable (credit) - following exact schema sequence
                // For credit notes, taxAmount will be negative if there's VAT
                // The condition checks if there's any VAT (positive or negative) and if VAT account exists
                if (Math.abs(taxAmount) > 0.001 && accounts.vat) {
                    xml += '        <VrsticaTemeljnice>\n';
                    xml += `          <OpisVrsticeTemeljnice>VAT - ${escapeXml(row['Number'] || '')}</OpisVrsticeTemeljnice>\n`;
                    xml += `          <SifraKonta>${escapeXml(accounts.vat)}</SifraKonta>\n`;
                    xml += `          <DatumOpravljanja>${invoiceDate}</DatumOpravljanja>\n`;
                    
                    // NOTE: OSS fields are NOT included on VAT entries - only on revenue entries
                    // VAT entries always use the standard element name without OSS fields
                    xml += `          <ZnesekVDobroVDomaciDenarniEnoti>${Math.abs(taxAmount).toFixed(2)}</ZnesekVDobroVDomaciDenarniEnoti>\n`;
                    xml += '        </VrsticaTemeljnice>\n';
                }
                
                xml += '      </VrsticeTemeljnice>\n';
                xml += '    </Temeljnica>\n';
            });
            
            xml += '  </Temeljnice>\n';
            xml += '</miniMAXUvozKnjigovodstvo>';
            
            return xml;
        }
        
        // EU countries list with mapping to ISO codes
        const EU_COUNTRIES = {
            'Austria': 'AT', 'Belgium': 'BE', 'Bulgaria': 'BG', 'Croatia': 'HR', 
            'Cyprus': 'CY', 'Czech Republic': 'CZ', 'Denmark': 'DK', 'Estonia': 'EE', 
            'Finland': 'FI', 'France': 'FR', 'Germany': 'DE', 'Greece': 'GR', 
            'Hungary': 'HU', 'Ireland': 'IE', 'Italy': 'IT', 'Latvia': 'LV', 
            'Lithuania': 'LT', 'Luxembourg': 'LU', 'Malta': 'MT', 'Netherlands': 'NL', 
            'Poland': 'PL', 'Portugal': 'PT', 'Romania': 'RO', 'Slovakia': 'SK', 
            'Slovenia': 'SI', 'Spain': 'ES', 'Sweden': 'SE'
        };
        
        // Country name to ISO code mapping (extends EU list)
        const COUNTRY_CODES = {
            ...EU_COUNTRIES,
            'Iceland': 'IS', 'Norway': 'NO', 'Switzerland': 'CH', 'United Kingdom': 'GB',
            'United States': 'US', 'Canada': 'CA', 'Australia': 'AU', 'Japan': 'JP',
            'South Korea': 'KR', 'China': 'CN', 'India': 'IN', 'Brazil': 'BR',
            'Mexico': 'MX', 'Turkey': 'TR', 'Russia': 'RU', 'Ukraine': 'UA',
            'Serbia': 'RS', 'Bosnia and Herzegovina': 'BA', 'North Macedonia': 'MK',
            'Montenegro': 'ME', 'Albania': 'AL', 'Moldova': 'MD', 'Belarus': 'BY'
        };
        
        function getCustomerCountry(row, countryColumnSetting) {
            // Auto-detect country column
            if (countryColumnSetting === 'auto') {
                // Prefer shipping country, then billing country, then generic country
                return row['Shipping Country'] || row['Billing Country'] || row['Country'] || '';
            }
            return row[countryColumnSetting] || '';
        }
        
        function classifyCountry(country, homeCountry) {
            if (!country) return 'domestic';
            
            // Normalize country names for comparison
            const normalizedCountry = country.trim();
            const normalizedHome = homeCountry.trim();
            
            // Check if it's the home country
            if (normalizedCountry.toLowerCase() === normalizedHome.toLowerCase()) {
                return 'domestic';
            }
            
            // Check if it's an EU country (check both full names and codes)
            const isEU = Object.keys(EU_COUNTRIES).some(euCountry => 
                euCountry.toLowerCase() === normalizedCountry.toLowerCase()
            ) || Object.values(EU_COUNTRIES).some(code => 
                code.toLowerCase() === normalizedCountry.toLowerCase()
            );
            
            if (isEU) {
                return 'eu';
            }
            
            // Everything else is third country
            return 'third';
        }
        
        function getAccountsByCountryType(countryType, businessType) {
            const accounts = {
                receivables: '1200',  // Default
                revenue: '7620',      // Default
                vat: '26000'          // Default
            };
            
            // Check for manual overrides first
            const overrides = getManualOverrides();
            
            if (countryType === 'domestic') {
                // Slovenia - domestic accounts
                accounts.receivables = overrides.domesticReceivables || '1200';
                accounts.vat = overrides.domesticVAT || '26000';
                
                if (overrides.domesticRevenue) {
                    accounts.revenue = overrides.domesticRevenue;
                } else {
                    switch (businessType) {
                        case 'products':
                            accounts.revenue = '7620';
                            break;
                        case 'services':
                            accounts.revenue = '7601';
                            break;
                        case 'goods':
                            accounts.revenue = '7600';
                            break;
                        case 'materials':
                            accounts.revenue = '7621';
                            break;
                        default:
                            accounts.revenue = '7620';
                    }
                }
            } else if (countryType === 'eu') {
                // EU countries
                accounts.receivables = overrides.euReceivables || '1211';
                accounts.vat = overrides.euVAT || '26071'; // OSS system
                
                if (overrides.euRevenue) {
                    accounts.revenue = overrides.euRevenue;
                } else {
                    switch (businessType) {
                        case 'products':
                            accounts.revenue = '76301';
                            break;
                        case 'services':
                            accounts.revenue = '76111';
                            break;
                        case 'goods':
                            accounts.revenue = '76101';
                            break;
                        case 'materials':
                            accounts.revenue = '76311';
                            break;
                        default:
                            accounts.revenue = '76301';
                    }
                }
            } else {
                // Third countries
                accounts.receivables = overrides.thirdReceivables || '1210';
                accounts.vat = overrides.thirdVAT || ''; // No VAT by default for third countries
                
                if (overrides.thirdRevenue) {
                    accounts.revenue = overrides.thirdRevenue;
                } else {
                    switch (businessType) {
                        case 'products':
                            accounts.revenue = '76302';
                            break;
                        case 'services':
                            accounts.revenue = '76112';
                            break;
                        case 'goods':
                            accounts.revenue = '76102';
                            break;
                        case 'materials':
                            accounts.revenue = '76312';
                            break;
                        default:
                            accounts.revenue = '76302';
                    }
                }
            }
            
            return accounts;
        }
        
        function getManualOverrides() {
            return {
                domesticReceivables: document.getElementById('domesticReceivables').value.trim(),
                domesticRevenue: document.getElementById('domesticRevenue').value.trim(),
                domesticVAT: document.getElementById('domesticVAT').value.trim(),
                euReceivables: document.getElementById('euReceivables').value.trim(),
                euRevenue: document.getElementById('euRevenue').value.trim(),
                euVAT: document.getElementById('euVAT').value.trim(),
                thirdReceivables: document.getElementById('thirdReceivables').value.trim(),
                thirdRevenue: document.getElementById('thirdRevenue').value.trim(),
                thirdVAT: document.getElementById('thirdVAT').value.trim()
            };
        }
        
        function updateAccountPreview() {
            const businessType = document.getElementById('businessType').value;
            
            // Get accounts for each market type
            const domesticAccounts = getAccountsByCountryType('domestic', businessType);
            const euAccounts = getAccountsByCountryType('eu', businessType);
            const thirdAccounts = getAccountsByCountryType('third', businessType);
            
            // Update preview displays
            document.getElementById('domesticPreview').textContent = 
                `Receivables: ${domesticAccounts.receivables} | Revenue: ${domesticAccounts.revenue} | VAT: ${domesticAccounts.vat}`;
            
            document.getElementById('euPreview').textContent = 
                `Receivables: ${euAccounts.receivables} | Revenue: ${euAccounts.revenue} | VAT: ${euAccounts.vat} (OSS)`;
            
            document.getElementById('thirdPreview').textContent = 
                `Receivables: ${thirdAccounts.receivables} | Revenue: ${thirdAccounts.revenue} | VAT: ${thirdAccounts.vat || 'No VAT'}`;
        }
        
        function formatDate(dateValue) {
            if (!dateValue) return new Date().toISOString().split('T')[0];
            
            // Handle Excel date serial numbers
            if (typeof dateValue === 'number') {
                // Excel epoch is December 30, 1899
                const excelEpoch = new Date(1899, 11, 30);
                const date = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                
                // Get the date components to avoid timezone issues
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            }
            
            // Handle string dates (like "4/1/25", "2025-04-01", etc.)
            if (typeof dateValue === 'string') {
                let date;
                
                // Try to parse various date formats
                if (dateValue.includes('/')) {
                    // Handle formats like "4/1/25", "04/01/25", "4/1/2025"
                    const parts = dateValue.split('/');
                    if (parts.length === 3) {
                        let month = parseInt(parts[0]);
                        let day = parseInt(parts[1]);
                        let year = parseInt(parts[2]);
                        
                        // Handle 2-digit years (assume 2000s)
                        if (year < 100) {
                            year += 2000;
                        }
                        
                        // Create date (month is 0-indexed in JavaScript)
                        date = new Date(year, month - 1, day);
                    }
                } else {
                    // Try parsing as standard date string
                    date = new Date(dateValue);
                }
                
                if (date && !isNaN(date.getTime())) {
                    // Get the date components to avoid timezone issues
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    
                    return `${year}-${month}-${day}`;
                }
            }
            
            // Fallback to current date
            return new Date().toISOString().split('T')[0];
        }
        
        function downloadXML() {
            try {
                console.log('Download button clicked');
                
                if (!generatedXML || generatedXML.trim() === '') {
                    showMessage('No XML to download. Please generate XML first.', 'error');
                    return;
                }
                
                console.log('XML length:', generatedXML.length);
                
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `minimax_invoices_v2.11_${timestamp}.xml`;
                
                console.log('Attempting download with filename:', filename);
                
                // Method 1: Modern blob approach
                try {
                    const blob = new Blob([generatedXML], { type: 'application/xml;charset=utf-8' });
                    console.log('Blob created successfully');
                    
                    if (typeof URL !== 'undefined' && URL.createObjectURL) {
                        const url = URL.createObjectURL(blob);
                        console.log('Object URL created');
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        a.style.display = 'none';
                        
                        document.body.appendChild(a);
                        console.log('Triggering download');
                        a.click();
                        
                        // Clean up
                        setTimeout(() => {
                            if (document.body.contains(a)) {
                                document.body.removeChild(a);
                            }
                            URL.revokeObjectURL(url);
                            console.log('Download cleanup completed');
                        }, 1000);
                        
                        showMessage('üéâ XML file downloaded successfully!', 'success');
                        return;
                    }
                } catch (blobError) {
                    console.error('Blob method failed:', blobError);
                }
                
                // Method 2: Data URI fallback
                console.log('Trying data URI fallback method');
                const dataStr = 'data:application/xml;charset=utf-8,' + encodeURIComponent(generatedXML);
                const a = document.createElement('a');
                a.href = dataStr;
                a.download = filename;
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    if (document.body.contains(a)) {
                        document.body.removeChild(a);
                    }
                }, 100);
                
                showMessage('üìÅ XML file downloaded (data URI method)!', 'success');
                
            } catch (error) {
                console.error('Download failed:', error);
                showMessage('Download failed: ' + error.message + '. Please try the copy method.', 'error');
                
                // Auto-try copy method as fallback
                setTimeout(() => {
                    copyToClipboard();
                }, 1000);
            }
        }
        
        function copyToClipboard() {
            try {
                if (!generatedXML || generatedXML.trim() === '') {
                    showMessage('No XML to copy. Please generate XML first.', 'error');
                    return;
                }
                
                console.log('Attempting to copy XML to clipboard, length:', generatedXML.length);
                
                // Try modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(generatedXML).then(() => {
                        showMessage('‚úÖ XML copied to clipboard successfully! Paste into text editor and save as .xml file.', 'success');
                        console.log('Copy successful via Clipboard API');
                    }).catch(err => {
                        console.error('Clipboard API failed:', err);
                        fallbackCopyToClipboard();
                    });
                } else {
                    console.log('Clipboard API not available, using fallback');
                    fallbackCopyToClipboard();
                }
                
            } catch (error) {
                console.error('Copy error:', error);
                showMessage('Copy failed. Please use "Preview XML" to manually copy the content.', 'error');
                // Auto-show preview
                setTimeout(() => {
                    togglePreview();
                }, 500);
            }
        }
        
        function fallbackCopyToClipboard() {
            try {
                // Create a temporary textarea
                const textArea = document.createElement('textarea');
                textArea.value = generatedXML;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    showMessage('üìã XML copied to clipboard!', 'success');
                } else {
                    showMessage('Copy failed. Please manually copy from the preview.', 'error');
                    togglePreview(); // Show preview for manual copy
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showMessage('Copy failed. Please manually copy from the preview.', 'error');
                togglePreview(); // Show preview for manual copy
            }
        }
        
        function togglePreview() {
            const preview = document.getElementById('xmlPreview');
            const toggleBtn = document.getElementById('previewToggle');
            
            if (preview.classList.contains('hidden')) {
                if (!generatedXML || generatedXML.trim() === '') {
                    showMessage('No XML to preview. Please generate XML first.', 'error');
                    return;
                }
                
                preview.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>üìÑ Generated XML Preview</h3>
                        <button class="btn btn-success" onclick="selectAllXML()" style="margin: 0;">
                            <span>üìã</span> Select All
                        </button>
                    </div>
                    <div style="background: #f0f0f0; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 0.9rem;">
                        <strong>üìÅ Save as:</strong> minimax_invoices_v2.11_${new Date().toISOString().split('T')[0]}.xml
                    </div>
                    <pre id="xmlContent" style="user-select: all; cursor: text; background: #fff; border: 2px solid #667eea; max-height: 400px; overflow-y: auto;">${escapeHtml(generatedXML)}</pre>
                `;
                preview.classList.remove('hidden');
                toggleBtn.innerHTML = '<span>üôà</span> Hide Preview';
            } else {
                preview.classList.add('hidden');
                toggleBtn.innerHTML = '<span>üëÅÔ∏è</span> Preview XML';
            }
        }
        
        function selectAllXML() {
            const xmlContent = document.getElementById('xmlContent');
            if (xmlContent) {
                // Create a range and select the content
                const range = document.createRange();
                range.selectNodeContents(xmlContent);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                // Try to copy automatically
                try {
                    document.execCommand('copy');
                    showMessage('üìã XML content selected and copied to clipboard!', 'success');
                } catch (err) {
                    showMessage('üìã XML content selected. Press Ctrl+C to copy.', 'info');
                }
            }
        }
        
        function showProcessing(message) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `
                <div class="processing">
                    <div class="spinner"></div>
                    ${message}
                </div>
            `;
        }
        
        function hideProcessing() {
            const messagesDiv = document.getElementById('messages');
            if (messagesDiv.querySelector('.processing')) {
                messagesDiv.innerHTML = '';
            }
        }
        
        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type}`;
            
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            messageDiv.innerHTML = `${icon} ${message}`;
            
            messagesDiv.innerHTML = '';
            messagesDiv.appendChild(messageDiv);
            
            // Auto-hide after 8 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 8000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function escapeXml(text) {
            if (text === null || text === undefined) return '';
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }
    </script>
</body>
</html>